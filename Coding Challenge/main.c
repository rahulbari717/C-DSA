
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Function to handle processed data once assembled
void process_data(uint8_t *assembled_data)
{
    printf("Processed data: \n\n%s\n\n", assembled_data);
    printf("\nEnter the characters shown in above image in the form 2\n");
}

// Global variables to store packet data
static uint8_t *data_buffer = NULL;
static uint16_t total_data_size = 0;
static uint8_t *received_packets = NULL;
static uint16_t received_count = 0;

void packet_decode(const uint8_t *packet)
{
    // Check header
    if (packet[0] != 0xAA)
        return;

    // Get packet length and verify footer
    uint8_t length = packet[1];
    if (packet[length - 1] != 0xBB)
        return;

    // Check device ID (0x01)
    if (packet[2] != 0x01)
        return;

    // Get packet number and total data size
    uint16_t packet_num = (packet[3] << 8) | packet[4];
    uint16_t data_size = (packet[5] << 8) | packet[6];

    // Calculate checksum (XOR of all bytes except header, footer, and checksum)
    uint8_t checksum = 0;
    for (int i = 1; i < length - 2; i++)
    {
        checksum ^= packet[i];
    }

    // Verify checksum
    if (checksum != packet[length - 2])
        return;

    // Initialize buffers if first valid packet
    if (data_buffer == NULL)
    {
        total_data_size = data_size;
        data_buffer = (uint8_t *)calloc(total_data_size + 1, 1);
        received_packets = (uint8_t *)calloc(total_data_size, 1);
    }

    // Calculate data length and copy data to buffer
    uint8_t data_length = length - 10;
    uint8_t *data_start = (uint8_t *)&packet[7];
    memcpy(data_buffer + packet_num * data_length, data_start, data_length);

    // Mark packet as received
    for (int i = 0; i < data_length; i++)
    {
        if (packet_num * data_length + i < total_data_size)
        {
            received_packets[packet_num * data_length + i] = 1;
        }
    }
    received_count++;

    // Check if all data received
    int complete = 1;
    for (int i = 0; i < total_data_size; i++)
    {
        if (!received_packets[i])
        {
            complete = 0;
            break;
        }
    }

    // Process complete data
    if (complete)
    {
        data_buffer[total_data_size] = '\0';
        process_data(data_buffer);

        // Cleanup
        free(data_buffer);
        free(received_packets);
        data_buffer = NULL;
        received_packets = NULL;
        received_count = 0;
    }
} // Main function to call packet_decode with each simulated packet
int main()
{
    // Simulating packet reception by calling packet_decode on each packet
    packet_decode((uint8_t[]){0xAA, 0x1F, 0x01, 0x00, 0x09, 0x01, 0x0C, 0x2D, 0x2D, 0x4F, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x6F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x3A, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x18, 0x01, 0x00, 0x0A, 0x01, 0x0C, 0x2F, 0x20, 0x5C, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x2D, 0x6F, 0x20, 0x0A, 0x25, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1F, 0x02, 0x00, 0x09, 0x01, 0x0C, 0x2D, 0x2D, 0x4F, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x6F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x3A, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x18, 0x03, 0x00, 0x0A, 0x01, 0x0C, 0x2F, 0x20, 0x5C, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x2D, 0x6F, 0x20, 0x0A, 0x25, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1D, 0x04, 0x00, 0x01, 0x01, 0x0C, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x6F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x6F, 0x2D, 0x78, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1D, 0x01, 0x00, 0x01, 0x01, 0x0C, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x6F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x6F, 0x2D, 0x78, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1B, 0x01, 0x00, 0x02, 0x01, 0x0C, 0x2D, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x57, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1D, 0x01, 0x00, 0x0B, 0x01, 0x0C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x46, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1D, 0x03, 0x00, 0x06, 0x01, 0x0C, 0x20, 0x20, 0x5C, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x4F, 0x20, 0x20, 0x20, 0x6F, 0x2D, 0x6F, 0x20, 0x0A, 0x7C, 0x20, 0x20, 0x70, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1C, 0x04, 0x00, 0x07, 0x01, 0x0C, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x5C, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x4B, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1A, 0x05, 0x00, 0x08, 0x01, 0x0C, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x0A, 0x6F, 0x47, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1F, 0x06, 0x00, 0x03, 0x01, 0x0C, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x5C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x1A, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1A, 0x07, 0x00, 0x04, 0x01, 0x0C, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0A, 0x37, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1E, 0x08, 0x00, 0x05, 0x01, 0x0C, 0x6F, 0x20, 0x20, 0x6F, 0x20, 0x4F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x7C, 0x20, 0x5C, 0x20, 0x7C, 0x20, 0x4F, 0x2D, 0x2D, 0x6F, 0x4B, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1B, 0x01, 0x00, 0x0C, 0x01, 0x0C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0A, 0x31, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1C, 0x01, 0x00, 0x0D, 0x01, 0x0C, 0x6F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3D, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1A, 0x01, 0x00, 0x0E, 0x01, 0x0C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x0C, 0x01, 0x00, 0x0F, 0x01, 0x0C, 0x20, 0x0A, 0x0A, 0x2F, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1D, 0x01, 0x00, 0x06, 0x01, 0x0C, 0x20, 0x20, 0x5C, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x4F, 0x20, 0x20, 0x20, 0x6F, 0x2D, 0x6F, 0x20, 0x0A, 0x7C, 0x20, 0x20, 0x70, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1B, 0x05, 0x00, 0x02, 0x01, 0x0C, 0x2D, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x57, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1D, 0x06, 0x00, 0x0B, 0x01, 0x0C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x46, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1B, 0x07, 0x00, 0x0C, 0x01, 0x0C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0A, 0x31, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1C, 0x08, 0x00, 0x0D, 0x01, 0x0C, 0x6F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x3D, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1A, 0x09, 0x00, 0x0E, 0x01, 0x0C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x0C, 0x02, 0x00, 0x0F, 0x01, 0x0C, 0x20, 0x0A, 0x0A, 0x2F, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1C, 0x01, 0x00, 0x07, 0x01, 0x0C, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x5C, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x4B, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1A, 0x01, 0x00, 0x08, 0x01, 0x0C, 0x20, 0x20, 0x6F, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x2F, 0x20, 0x20, 0x0A, 0x6F, 0x47, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1F, 0x01, 0x00, 0x03, 0x01, 0x0C, 0x0A, 0x20, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x5C, 0x20, 0x20, 0x7C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x1A, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1A, 0x01, 0x00, 0x04, 0x01, 0x0C, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5C, 0x20, 0x2F, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x0A, 0x37, 0xBB});
    packet_decode((uint8_t[]){0xAA, 0x1E, 0x01, 0x00, 0x05, 0x01, 0x0C, 0x6F, 0x20, 0x20, 0x6F, 0x20, 0x4F, 0x2D, 0x2D, 0x6F, 0x20, 0x20, 0x7C, 0x20, 0x5C, 0x20, 0x7C, 0x20, 0x4F, 0x2D, 0x2D, 0x6F, 0x4B, 0xBB});

    return 0;
}